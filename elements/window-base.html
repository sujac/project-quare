<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="stylesheet" polymer-scope="global" href="../css/fonts.css">

<polymer-element name="window-base" attributes="name height width left top marginTop" on-mousedown="{{clicked}}" class="hidden"> 
    <template>
        <polymer-signals on-polymer-signal-inactive="{{updateState}}"></polymer-signals>
        <link rel="stylesheet" href="window-base.css">
        <link rel="stylesheet" href="../css/icons.css">
        <div id="box">
            <div class="resizer" id="resizer-top" on-track="{{trackTop}}"></div>
            <div class="resizer" id="resizer-left" on-track="{{trackLeft}}"></div>
            <div class="resizer" id="resizer-bottom" on-track="{{trackBottom}}"></div>
            <div class="resizer" id="resizer-right" on-track="{{trackRight}}"></div>
            <div class="resizer" id="bottom-right-diagonal" on-track="{{trackBottomRight}}"></div>
            <div class="resizer" id="bottom-left-diagonal" on-track="{{trackBottomLeft}}"></div>
            <div class="resizer" id="top-right-diagonal" on-track="{{trackTopRight}}"></div>
            <div class="resizer" id="top-left-diagonal" on-track="{{trackTopLeft}}"></div>
            <header id="header" on-trackstart="{{trackStartDraggable}}" on-track="{{trackDraggable}}" on-trackend="{{trackEndDraggable}}">
                <span class="control-icon icon-CLOSE" on-click="{{closeWindow}}"></span>
                <span class="control-icon icon-MINUS"></span>
                <span class="control-icon icon-MAXIMIZE" on-click="{{maximizeWindow}}"></span>
            </header>
            <content></content>
        </div>
    </template>
    <script>
        Polymer('window-base', {
            name: "finder",
            height: 400,
            width: 500,
            auxHeight: 0,
            auxWidth: 0,
            pointerX: 0,
            pointerY: 0,
            marginTop: 35,
            zNumber: 0,
            maximized: false,
            left: 300,
            top: 200,
            observe: {
                left: 'positionChanged',
                top: 'positionChanged'
            },
            /* -- Lifecycle ------------------------------------------------- */
            domReady: function () {
                this.heightChanged();
                this.widthChanged();
                this.positionChanged();
                this.inactive();
                this.classList.add('active');

            },
            /* -- AUTOMATIC AND DYNAMIC IMPORT BASED ON ATTRIBUTE --------------------------------------------------- */
            attached: function () {
                Polymer.import(['elements/app-window/' + this.name + '-app.html'], function () {
                    this.onComplete();
                }.bind(this));
            },
            /* -- Changed watchers ------------------------------------------ */
            heightChanged: function () {
                this.$.box.style.height = this.height + 'px';
            },
            widthChanged: function () {
                this.$.box.style.width = this.width + 'px';
            },
            zNumberChanged: function (oldValue, newValue) {
                this.style.zIndex = this.zNumber;
            },
            positionChanged: function () {
                var s = this.style;
                var translate = "translate(" + this.left + "px, " + this.top + "px)";
                s.webkitTransform = s.mozTransform = s.msTransform = s.transform = translate;
            },
            /* -- Methods --------------------------------------------------- */
            onComplete: function () {
                var app = document.createElement(this.name + "-app");
                this.appendChild(app);
            },
            inactive: function () {
                this.fire('polymer-signal', {
                    name: "inactive"
                });
            },
            clicked: function () {
                if (!this.classList.contains("active")) {
                    /* -- SPECIFIC SIGNAL FOR INSTANCED ELEMENT ----*/
                    this.fire('polymer-signal', {
                        name: this.name
                    });
                    this.inactive();
                    this.classList.add('active'); //add active class only to the clicked one
                    this.zNumber = this.zNumber + 4; //needs more timeeeeeeee
                }
            },
            options: function (object) {
                ("width" in object) ? this.width = object.width : "";
                ("height" in object) ? this.height = object.height : "";
                ("top" in object) ? this.top = object.top : "";
                ("left" in object) ? this.left = object.left : "";
                this.classList.remove("hidden");
            },
            updateState: function () {
                this.zNumber = (this.zNumber - 2) <= 0 ? 0 : (this.zNumber - 2);
                this.classList.remove('active'); //remove active class from every window-base instance
            },
            trackRight: function (event, detail, sender) {
                this.width = event.clientX - this.left;
            },
            trackLeft: function (event, detail, sender) {
                this.width = this.width - (event.clientX - this.left);
                this.left = event.clientX;
            },
            trackBottom: function (event, detail, sender) {
                this.height = event.clientY - this.top;
            },
            trackTop: function (event, detail, sender) {
                this.height = this.height - (event.clientY - this.top);
                this.top = event.clientY;
            },
            trackBottomRight: function (event, detail, sender) {
                this.width = event.clientX - this.left;
                this.height = event.clientY - this.top;
            },
            trackBottomLeft: function (event, detail, sender) {
                this.height = event.clientY - this.top;
                this.width = this.width - (event.clientX - this.left);
                this.left = event.clientX;
            },
            trackTopRight: function (event, detail, sender) {
                this.height = this.height - (event.clientY - this.top);
                this.top = event.clientY;
                this.width = event.clientX - this.left;
            },
            trackTopLeft: function (event, detail, sender) {
                this.height = this.height - (event.clientY - this.top);
                this.top = event.clientY;
                this.width = this.width - (event.clientX - this.left);
                this.left = event.clientX;
            },
            trackStartDraggable: function (event, detail, sender) {
                this.$.header.classList.add('dragging');
                if (this.classList.contains("resized")) {
                    this.left = event.clientX - this.pointerX;
                    this.resizeWindow();
                    this.classList.remove("resized");
                } else if (this.classList.contains("resized-up")) {
                    this.left = event.clientX - this.pointerX;
                    this.resizeWindow();
                    this.classList.remove("resized-up");
                }
                this.pointerY = event.clientY - this.top;
                this.pointerX = event.clientX - this.left;
            },
            trackDraggable: function (event, detail, sender) {
                this.top = event.clientY - this.pointerY;
                this.left = event.clientX - this.pointerX;
            },
            trackEndDraggable: function (event, detail, sender) {
                this.$.header.classList.remove('dragging');
                var screenWidth = window.innerWidth;
                var screenHeight = window.innerHeight;
                this.auxWidth = this.width;
                this.auxHeight = this.height;
                if (event.clientX >= (screenWidth - 10)) {
                    this.classList.add('resized');
                    this.width = this.left = screenWidth / 2;
                    this.height = screenHeight;
                    this.top = this.marginTop;
                } else if (event.clientX <= 10) {
                    this.classList.add('resized');
                    this.width = screenWidth / 2;
                    this.left = 0;
                    this.height = screenHeight;
                    this.top = this.marginTop;
                } else if (event.clientY <= 5) {
                    this.classList.add('resized-up');
                    this.maxWindow();
                }
            },
            accesChild: function (child) {
                this.options(child.getOptions());
            },
            closeWindow: function (event, detail, sender) {
                this.remove();
            },
            maximizeWindow: function (event, detail, sender) {
                if (!this.maximized){
                    this.auxWidth = this.width;
                    this.auxHeight = this.height;
                    this.top = this.marginTop;
                    this.left = 0;
                    this.width = window.innerWidth;
                    this.height = window.innerHeight;
                    this.maximized = true;
                }else{
                    this.left = event.clientX;
                    this.resizeWindow();
                    this.maximized = false;
                }
            },
            maxWindow: function () {
                this.top = this.marginTop;
                this.left = 0;
                this.width = window.innerWidth;
                this.height = window.innerHeight;
            },
            resizeWindow: function () {
                this.width = this.auxWidth;
                this.height = this.auxHeight;            
            }
        });
    </script>
</polymer-element>
